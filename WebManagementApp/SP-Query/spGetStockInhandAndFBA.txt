CREATE PROCEDURE spGetStockInhandAndFBA
AS
BEGIN
	SET NOCOUNT ON;
	
	SELECT ms.sku AS MasterSKU, ms.Title, qty_data.TotalQty, fba_data.FBA, ms.GTIN, b.Brand, fba_data.FBAGreenwize, fba_data.FBAAVASupplies
	FROM tblMastersku ms
	LEFT JOIN (SELECT sl.idMasterSKU,
	CASE 
		WHEN SUM(CASE WHEN sl.StockLocation IN ('Amersham', 'Watford') THEN sl.Quantity ELSE NULL END) IS NULL THEN NULL
		ELSE COALESCE(SUM(CASE WHEN sl.StockLocation IN ('Amersham', 'Watford') THEN sl.Quantity ELSE 0 END), 0)
	END AS TotalQty
	FROM tblStockLocation sl GROUP BY sl.idMasterSKU) AS qty_data 
	ON ms.idMasterSKU = qty_data.idMasterSKU
	LEFT JOIN tblBrand b ON ms.idBrand = b.idBrand
	LEFT JOIN (SELECT mps.idMasterSKU,
	CASE
		WHEN SUM(CASE WHEN ai.FulfillmentBy = 'FBA' AND LOWER(ai.Source) = 'GB' THEN 1 ELSE 0 END) = 0 THEN NULL
		ELSE COALESCE(NULLIF(SUM(CASE WHEN ai.FulfillmentBy = 'FBA' AND LOWER(ai.Source) = 'GB' THEN ai.Quantity ELSE 0 END), 0), 0)
	END AS FBA,
	CASE
		WHEN SUM(CASE WHEN ai.FulfillmentBy = 'FBA' AND LOWER(ai.Source) = 'GB' AND LOWER(mps.CompanyName) = 'greenwize' 
			AND LOWER(ai.CompanyName) = 'greenwize' THEN 1 ELSE 0 END) = 0 THEN NULL
		ELSE COALESCE(NULLIF(SUM(CASE WHEN ai.FulfillmentBy = 'FBA' AND LOWER(ai.Source) = 'GB' AND LOWER(mps.CompanyName) = 'greenwize' 
			AND LOWER(ai.CompanyName) = 'greenwize' THEN ai.Quantity ELSE 0 END), 0), 0)
	END AS FBAGreenwize,
	CASE
		WHEN SUM(CASE WHEN ai.FulfillmentBy = 'FBA' AND LOWER(ai.Source) = 'GB' AND LOWER(mps.CompanyName) = 'ava supplies' 
			AND LOWER(ai.CompanyName) = 'ava supplies' THEN 1 ELSE 0 END) = 0 THEN NULL
		ELSE COALESCE(NULLIF(SUM(CASE WHEN ai.FulfillmentBy = 'FBA' AND LOWER(ai.Source) = 'GB' AND LOWER(mps.CompanyName) = 'ava supplies' 
			AND LOWER(ai.CompanyName) = 'ava supplies' THEN ai.Quantity ELSE 0 END), 0), 0)
	END AS FBAAVASupplies
	FROM tblMappingsku mps LEFT JOIN tblAmazonInventory ai ON mps.sku = ai.sku AND mps.CompanyName = ai.CompanyName
	WHERE LOWER(mps.SalesChannel) = 'amazon' GROUP BY mps.idMasterSKU) AS fba_data 
	ON ms.idMasterSKU = fba_data.idMasterSKU ORDER BY ms.sku ASC;

END;