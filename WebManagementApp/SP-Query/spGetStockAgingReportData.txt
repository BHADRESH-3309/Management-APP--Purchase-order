CREATE PROCEDURE spGetStockAgingReportData
	@BrandName NVARCHAR(100)

AS
BEGIN

    -- Author: Dharmil Patel
	WITH FBAQuantity AS(
	SELECT m.SKU, m.idMasterSKU,
	CASE 
		WHEN SUM(CASE WHEN ai.FulfillmentBy = 'FBA' THEN 1 ELSE 0 END) = 0 THEN NULL
		ELSE COALESCE(NULLIF(SUM(CASE WHEN ai.FulfillmentBy = 'FBA' THEN ai.Quantity ELSE 0 END), 0), 0)
	END AS FBA
	FROM tblMastersku m
	LEFT JOIN tblMappingsku ms 
	ON m.idMasterSKU = ms.idMasterSKU 
	AND LOWER(ms.SalesChannel) = 'amazon'
	LEFT JOIN tblAmazonInventory ai 
	ON ms.sku = ai.sku 
	GROUP BY m.SKU, m.idMasterSKU
	),
	StockQuantities AS (
	SELECT 
	m.sku AS MasterSKU,
	CASE 
		WHEN SUM(CASE WHEN sl.StockLocation = 'Amersham' THEN sl.Quantity ELSE NULL END) IS NULL THEN NULL
		ELSE COALESCE(SUM(CASE WHEN sl.StockLocation = 'Amersham' THEN sl.Quantity ELSE 0 END), 0)
	END AS AmershamQty,
	CASE 
		WHEN SUM(CASE WHEN sl.StockLocation = 'Watford' THEN sl.Quantity ELSE NULL END) IS NULL THEN NULL
		ELSE COALESCE(SUM(CASE WHEN sl.StockLocation = 'Watford' THEN sl.Quantity ELSE 0 END), 0)
	END AS WatfordQty
	FROM tblMastersku m
	LEFT JOIN tblStockLocation sl ON m.idMasterSKU = sl.idMasterSKU
	GROUP BY m.sku
	)
	SELECT ms.SKU AS MasterSKU, ms.Title, b.Brand, fba.FBA, ms.GTIN,
	CASE
	WHEN sq.AmershamQty IS NULL AND sq.WatfordQty IS NULL AND fba.FBA IS NULL THEN NULL
	ELSE COALESCE(sq.AmershamQty, 0) + COALESCE(sq.WatfordQty, 0) + COALESCE(fba.FBA, 0)
	END AS TotalQty,
	CASE 
	WHEN EXISTS (
	SELECT 1 FROM tblStockLocation sl2 
	WHERE sl2.idMasterSKU = ms.idMasterSKU
	) THEN FORMAT((SELECT MAX(sl2.StockAddDate)
				FROM tblStockLocation sl2 
				WHERE sl2.idMasterSKU = ms.idMasterSKU), 'dd/MM/yyyy')
	ELSE NULL
	END AS DateAdd,
	CASE 
	WHEN EXISTS (
	SELECT 1 FROM tblStockLocation sl2 
	WHERE sl2.idMasterSKU = ms.idMasterSKU
	) THEN DATEDIFF(DAY, 
	(SELECT MAX(sl2.StockAddDate)
		FROM tblStockLocation sl2 
		WHERE sl2.idMasterSKU = ms.idMasterSKU)
	, GETDATE())
	ELSE NULL
	END AS Age
	FROM FBAQuantity fba JOIN tblMasterSKU ms ON ms.idMasterSKU = fba.idMasterSKU
	LEFT JOIN tblStockLocation sl ON ms.idMasterSKU = sl.idMasterSKU 
	LEFT JOIN StockQuantities sq ON ms.SKU = sq.MasterSKU
	LEFT JOIN tblBrand b ON ms.idBrand = b.idBrand
	WHERE (@BrandName IS NULL OR @BrandName = '' OR b.Brand = @BrandName)
	GROUP BY ms.idMasterSKU, ms.SKU, ms.Title, ms.GTIN, b.Brand, fba.FBA,  sq.AmershamQty, sq.WatfordQty
	ORDER BY ms.SKU ASC;

END
GO