CREATE PROCEDURE spGetStockInhandAndFBA
AS
BEGIN
	SET NOCOUNT ON;
	
	SELECT ms.sku AS MasterSKU, ms.Title, qty_data.TotalQty, fba_data.FBA, ms.GTIN, b.Brand FROM tblMastersku ms
	LEFT JOIN (SELECT sl.idMasterSKU,
	CASE 
		WHEN SUM(CASE WHEN sl.StockLocation IN ('Amersham', 'Watford') THEN sl.Quantity ELSE NULL END) IS NULL THEN NULL
		ELSE COALESCE(SUM(CASE WHEN sl.StockLocation IN ('Amersham', 'Watford') THEN sl.Quantity ELSE 0 END), 0)
	END AS TotalQty
	FROM tblStockLocation sl GROUP BY sl.idMasterSKU) AS qty_data 
	ON ms.idMasterSKU = qty_data.idMasterSKU
	LEFT JOIN tblBrand b ON ms.idBrand = b.idBrand
	LEFT JOIN (SELECT mps.idMasterSKU,
	CASE
		WHEN SUM(CASE WHEN ai.FulfillmentBy = 'FBA' THEN 1 ELSE 0 END) = 0 THEN NULL
		ELSE COALESCE(NULLIF(SUM(CASE WHEN ai.FulfillmentBy = 'FBA' THEN ai.Quantity ELSE 0 END), 0), 0)
	END AS FBA
	FROM tblMappingsku mps LEFT JOIN tblAmazonInventory ai ON mps.sku = ai.sku 
	WHERE LOWER(mps.SalesChannel) = 'amazon' GROUP BY mps.idMasterSKU) AS fba_data 
	ON ms.idMasterSKU = fba_data.idMasterSKU ORDER BY ms.sku ASC;

END;